<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weź się do roboty</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🎯</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

    <style>
        /* --- Zmienne Kolorów --- */
        :root {
            --bg-light: #FDF6F6;
            --bg-dark: #2C2C3E;
            --text-light: #333;
            --text-dark: #f0f0f0;
            --noise-light: url("data:image/svg+xml,%3Csvg viewBox='0 0 1000 1000' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            --noise-dark: url("data:image/svg+xml,%3Csvg viewBox='0 0 1000 1000' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='1.2' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");

            --c-red: #ff8a80;
            --c-orange: #ffca80;
            --c-yellow: #ffd700;
            --c-green: #c8e6c9;
            --c-mint: #a7ffeb;
            --c-lavender: #e1bee7;
            --c-peach: #ffccbc;
            --c-pink: #f8bbd0;
            --c-blue: #b3e5fc;
            
            --c-red-dark: #c62828;
            --c-yellow-dark: #f9a825;
            --c-green-dark: #2e7d32;

            --card-bg-light: rgba(255, 255, 255, 0.7);
            --card-bg-dark: rgba(50, 50, 70, 0.7);
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
            --transition: all 0.5s ease;
        }

        /* --- Podstawowe Style --- */
        *, *::before, *::after { box-sizing: border-box; }
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--noise-light);
            opacity: 0.1;
            pointer-events: none;
            z-index: -1;
            transition: var(--transition);
        }

        /* --- Tryb Ciemny --- */
        body.dark-mode {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }
        body.dark-mode::after {
            background-image: var(--noise-dark);
            opacity: 0.08;
        }
        body.dark-mode .card { background-color: var(--card-bg-dark); }
        body.dark-mode .nav-bar { background-color: #383854; border-top: 1px solid #4a4a6a;}
        body.dark-mode .nav-button.active { color: var(--c-mint); }
        body.dark-mode .modal-content { background-color: #383854; }

        /* --- Nagłówek --- */
        header {
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            flex-shrink: 0;
            transition: transform 0.3s ease-in-out;
        }

        .app-title {
            font-weight: 700;
            font-size: 1.8rem;
            background: linear-gradient(45deg, var(--c-lavender), var(--c-peach), var(--c-mint));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-actions { display: flex; align-items: center; gap: 0.5rem; }
        .header-actions button {
            background: none; border: none; font-size: 1.5rem; cursor: pointer; color: inherit;
        }

        /* --- Główna zawartość --- */
        main {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 1.5rem 80px 1.5rem;
        }
        .page { display: none; }
        .page.active { display: block; }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        /* --- Karty --- */
        .card {
            background: var(--card-bg-light);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: var(--transition);
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            flex-direction: column;
        }
        .card-title {
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- Dolna Nawigacja --- */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid rgba(0,0,0,0.05);
            z-index: 100;
            transition: transform 0.3s ease-in-out;
        }
        .nav-button {
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #888;
            font-size: 0.7rem;
            transition: color 0.3s ease;
            flex-grow: 1;
            text-align: center;
        }
        .nav-button .icon { font-size: 1.4rem; }
        .nav-button.active { color: var(--c-peach); }
        .nav-button:hover { color: var(--c-lavender); }

        /* --- Modale --- */
        .modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .modal.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            transform: scale(0.9);
            transition: all 0.3s ease;
        }
        .modal.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; }
        .modal-title { margin-top: 0; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; }

        /* --- Formularze --- */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500;}
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            font-family: inherit;
        }
        body.dark-mode .form-group input, body.dark-mode .form-group select, body.dark-mode .form-group textarea {
            background-color: #4a4a6a;
            border-color: #5a5a7a;
            color: var(--text-dark);
        }
        .form-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }
        .form-actions button {
            background: none; border: none; font-size: 2rem; cursor: pointer;
        }
        .checkbox-group { display: flex; align-items: center; gap: 0.5rem; }
        
        /* --- Macierz Eisenhowera --- */
        #eisenhower-matrix {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            min-height: 500px;
        }
        .quadrant {
            border-radius: 1rem;
            padding: 1rem;
            border: 2px dashed rgba(0,0,0,0.1);
        }
        .quadrant-title { font-weight: 600; margin-top: 0; }
        #q1 { background-color: rgba(255, 138, 128, 0.2); border-color: var(--c-red); }
        #q2 { background-color: rgba(255, 202, 128, 0.2); border-color: var(--c-orange); }
        #q3 { background-color: rgba(255, 215, 0, 0.2); border-color: var(--c-yellow); }
        #q4 { background-color: rgba(200, 230, 201, 0.2); border-color: var(--c-green); }

        .task {
            background: var(--card-bg-light);
            padding: 0.8rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: grab;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .task.completed label span {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .task.delegated {
            opacity: 0.8;
            border-left: 4px solid var(--c-blue);
        }
        .task.dragging { opacity: 0.5; }
        .task-actions button { background: none; border: none; cursor: pointer; opacity: 0.5; }
        .task-actions button:hover { opacity: 1; }
        .task-date { font-size: 0.8em; opacity: 0.7; }
        
        /* --- Inne komponenty --- */
        #payments-list .payment-item, #ideas-list .idea-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .payment-status {
            display: inline-block;
            padding: 0.3em 0.8em;
            border-radius: 1em;
            font-size: 0.8em;
            font-weight: 600;
            color: #fff;
            margin-left: 10px;
        }
        .status-paid { background-color: var(--c-green-dark); }
        .status-overdue { background-color: var(--c-red-dark); }
        .status-approaching { background-color: var(--c-yellow-dark); color: #333;}
        .status-pending { background-color: #90a4ae; }

        .person-label {
            display: inline-block;
            padding: 0.3em 0.8em;
            border-radius: 1em;
            font-size: 0.8em;
            font-weight: 600;
        }
        .person-Zosia { background-color: #f8bbd0; color: #5c2334; }
        .person-Tymek { background-color: #b3e5fc; color: #013a5c; }
        .person-Karolina { background-color: #e1bee7; color: #3d2247; }
        .person-Tomek { background-color: #c8e6c9; color: #254a26; }

        /* Sekcja Zdrowia */
        #health-list h3 {
            margin-top: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid rgba(0,0,0,0.1);
            color: var(--c-peach);
        }
        body.dark-mode #health-list h3 {
            border-bottom-color: rgba(255,255,255,0.1);
            color: var(--c-mint);
        }
        .health-item {
            background: rgba(0,0,0,0.02);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            transition: var(--transition);
        }
        .health-item.next-appointment {
            box-shadow: 0 0 15px var(--c-peach);
            border: 1px solid var(--c-peach);
        }
        body.dark-mode .health-item { background: rgba(255,255,255,0.05); }
        .health-content { flex-grow: 1; }
        .health-item .appointment-details {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding-bottom: 0.75rem;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        body.dark-mode .health-item .appointment-details { border-bottom-color: rgba(255,255,255,0.1); }
        .health-item .appointment-info {
            font-weight: 600;
            font-size: 1.1em;
        }
        .health-item .mood-details { font-weight: 500; }
        .health-item .health-notes {
            font-size: 0.9em;
            color: #666;
            margin-top: 0.5rem;
        }
        body.dark-mode .health-item .health-notes { color: #ccc; }


        .btn {
            background: var(--c-peach);
            color: var(--text-light);
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 2rem;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }
        .btn:hover { transform: translateY(-2px); }
        
        #qr-code-container { text-align: center; margin-top: 1rem; }

        /* --- NOWE/ULEPSZONE KOMPONENTY --- */
        #focus-modal .modal-content { text-align: center; }
        #focus-timer { font-size: 5rem; font-weight: 700; margin: 2rem 0; }
        
        #wins-list li { margin-bottom: 0.5rem; }
        #add-win-form { display: flex; gap: 0.5rem; margin-top: auto; } /* ZMIANA: marginTop auto */
        #add-win-form input { flex-grow: 1; }
        #add-win-form button { padding: 0.8rem; border-radius: 0.5rem; background-color: var(--c-peach); }
        
        .meal-planner-actions {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        
        #notebook-container { position: relative; }
        #notebook-area {
            width: 100%;
            height: 60vh;
            border-radius: 0.5rem;
            border: 1px solid #ddd;
            padding: 1rem;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
        }
        #notebook-sorter-btn {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        #grouped-shopping-list { margin-top: 1rem; }
        #grouped-shopping-list h4 { color: var(--c-peach); }
        body.dark-mode #grouped-shopping-list h4 { color: var(--c-mint); }

        .goal-item {
            background: rgba(0,0,0,0.02);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .goal-item h4 { margin-top: 0; display: flex; justify-content: space-between; align-items: center;}
        .goal-item progress {
            width: 100%;
            height: 10px;
            margin: 0.5rem 0;
        }
        .goal-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }
        
        /* NOWA SEKCJA: CHECKLISTA */
        #checklist-list .checklist-item {
            display: flex;
            align-items: center;
            padding: 0.8rem;
            background: rgba(0,0,0,0.02);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        #checklist-list .checklist-item.completed label {
            text-decoration: line-through;
            opacity: 0.6;
        }
        #checklist-list .checklist-item label { flex-grow: 1; margin-left: 0.5rem;}
        #add-checklist-form { display: flex; gap: 0.5rem; margin-top: 1rem; }
        #add-checklist-form input { flex-grow: 1; }
        #add-checklist-form button { padding: 0.8rem; border-radius: 0.5rem; background-color: var(--c-peach); }

        /* ZMIANA: Style dla Trybu Zen */
        body.zen-mode header { transform: translateY(-120%); }
        body.zen-mode .nav-bar { transform: translateY(120%); }
        body.zen-mode main { padding-bottom: 1.5rem; }
        #exit-zen-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--c-peach);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1100;
            display: none; /* Ukryty domyślnie */
        }
        body.zen-mode #exit-zen-btn { display: block; }

        
        /* --- Responsywność --- */
        @media (max-width: 768px) {
            .app-title { font-size: 1.5rem; }
            main { padding: 0 1rem 80px 1rem; }
            #eisenhower-matrix { grid-template-columns: 1fr; }
            .nav-button .label { display: none; }
        }
    </style>
</head>
<body>

    <header>
        <h1 class="app-title">Weź się do roboty</h1>
        <div class="header-actions">
            <button id="zen-mode-btn" title="Tryb Zen">👁️</button>
            <button id="focus-btn" title="Tryb Skupienia">🎯</button>
            <button id="theme-toggle" title="Zmień motyw">🌙</button>
            <button id="sync-button" title="Synchronizuj">🔄</button>
        </div>
    </header>

    <main>
        <section id="pulpit" class="page active">
             <div class="card-title">
                <h2>Witaj, Karolka!</h2>
                <button id="weekly-review-btn" class="btn">Review Tygodnia</button>
            </div>
            <div class="grid-container">
                <div class="card">
                    <h2 class="card-title">⭐ Priorytety</h2>
                    <div id="daily-priorities"></div>
                </div>
                <div class="card">
                    <h2 class="card-title">🏆 Zwycięstwa</h2>
                    <ul id="wins-list" style="padding-left: 20px; flex-grow: 1;"></ul>
                    <form id="add-win-form">
                        <input type="text" id="win-input" placeholder="Co Ci się dziś udało?" required>
                        <button type="submit">➕</button>
                    </form>
                </div>
                 <div class="card">
                    <h2 class="card-title">💡 Motto</h2>
                    <p id="daily-motto"></p>
                </div>
                <div class="card">
                    <h2 class="card-title">🚀 Cel na dziś</h2>
                    <p id="daily-goal-proposal"></p>
                </div>
                <div class="card">
                    <h2 class="card-title">🎯 Zad. strategiczne</h2>
                    <p id="strategic-goals"></p>
                </div>
                <div class="card">
                    <h2 class="card-title">📈 Zad. operacyjne</h2>
                    <p id="kpi-goals"></p>
                </div>
                <div class="card">
                    <h2 class="card-title">💖 Dla Ciebie</h2>
                    <p id="self-care-idea"></p>
                </div>
                <div class="card">
                    <h2 class="card-title">🧹 Dla Domu</h2>
                    <p id="cleaning-motivator"></p>
                </div>
                 <div class="card">
                    <h2 class="card-title">⏰ Pilne płatności</h2>
                    <div id="urgent-payments"></div>
                </div>
                <div class="card">
                    <h2 class="card-title">🩺 Nadchodzące wizyty</h2>
                    <div id="upcoming-appointments"></div>
                </div>
            </div>
        </section>

        <section id="zadania" class="page">
            <h2 class="card-title" style="padding: 0 1rem;">
                Macierz Zadań
                <button id="sync-tasks-gcal-btn" class="btn">🗓️ Synchronizuj</button>
            </h2>
            <div id="eisenhower-matrix">
                <div class="quadrant" id="q1" data-quadrant="1">
                    <h3 class="quadrant-title">🔴 Pilne i Ważne</h3>
                    <div class="task-list"></div>
                </div>
                <div class="quadrant" id="q2" data-quadrant="2">
                    <h3 class="quadrant-title">🟠 Ważne, niepilne</h3>
                    <div class="task-list"></div>
                </div>
                <div class="quadrant" id="q3" data-quadrant="3">
                    <h3 class="quadrant-title">🟡 Pilne, nieważne</h3>
                    <div class="task-list"></div>
                </div>
                <div class="quadrant" id="q4" data-quadrant="4">
                    <h3 class="quadrant-title">⚪ Ani pilne, ani ważne</h3>
                    <div class="task-list"></div>
                </div>
            </div>
            <button id="add-task-btn" class="btn" style="position: fixed; bottom: 80px; right: 20px;">+ Zadanie</button>
        </section>

        <section id="platnosci" class="page">
             <div class="card">
                <h2 class="card-title">Twoje płatności</h2>
                <div id="payments-list"></div>
            </div>
            <button id="add-payment-btn" class="btn" style="position: fixed; bottom: 80px; right: 20px;">+ Płatność</button>
        </section>

        <section id="zdrowie" class="page">
             <div class="card">
                <h2 class="card-title">
                    Monitor Zdrowia
                    <button id="sync-health-gcal-btn" class="btn">🗓️ Synchronizuj</button>
                </h2>
                <div id="health-list"></div>
            </div>
            <button id="add-health-btn" class="btn" style="position: fixed; bottom: 80px; right: 20px;">+ Wpis</button>
        </section>
        
        <section id="posilki" class="page">
            <div class="card">
                <h2 class="card-title">💡 Inspiracje kulinarne na dziś</h2>
                <div id="daily-meal-ideas"></div>
            </div>
            <div class="card">
                <h2 class="card-title">🛒 Lista Zakupów</h2>
                <textarea id="shopping-list" rows="10" placeholder="Wpisz tutaj produkty..."></textarea>
                <div class="meal-planner-actions">
                    <button id="group-shopping-list-btn" class="btn">Grupuj listę</button>
                </div>
                <div id="grouped-shopping-list"></div>
            </div>
        </section>
        
        <section id="checklista" class="page">
            <div class="card">
                <h2 class="card-title">📋 Checklista Dnia</h2>
                <p>Prosta lista zadań do odhaczenia. Dane resetują się o północy.</p>
                <div id="checklist-list"></div>
                <form id="add-checklist-form">
                    <input type="text" id="checklist-input" placeholder="Dodaj zadanie do checklisty..." required>
                    <button type="submit">➕</button>
                </form>
            </div>
        </section>

        <section id="pomysly" class="page">
             <div class="card">
                <h2 class="card-title">Twoje pomysły</h2>
                <div id="ideas-list"></div>
            </div>
            <button id="add-idea-btn" class="btn" style="position: fixed; bottom: 80px; right: 20px;">💡 Szybki pomysł</button>
        </section>

        <section id="cele" class="page">
            <div class="card">
                <h2 class="card-title">🌱 Twoje Cele</h2>
                <div id="goals-list"></div>
                <button id="add-goal-btn" class="btn" style="margin-top: 1rem;">+ Nowy Cel</button>
            </div>
        </section>
        
        <section id="notatnik" class="page">
            <div class="card">
                <h2 class="card-title">📝 Magiczny Notatnik</h2>
                <p>Zapisz wszystko, co przyjdzie Ci do głowy. Kliknij 🪄 aby asystent posortował notatki za Ciebie.</p>
                <div id="notebook-container">
                    <textarea id="notebook-area" placeholder="Twoje myśli, pomysły, zadania... np. 'wizyta Zosi u lekarza jutro o 10', 'kupić mleko', 'zapłacić fakturę do piątku'"></textarea>
                    <button id="notebook-sorter-btn" class="btn" title="Zrób z tym porządek!">🪄</button>
                </div>
            </div>
        </section>
    </main>

    <nav class="nav-bar">
        <button class="nav-button active" data-page="pulpit"><span class="icon">🏠</span><span class="label">Pulpit</span></button>
        <button class="nav-button" data-page="zadania"><span class="icon">✅</span><span class="label">Zadania</span></button>
        <button class="nav-button" data-page="platnosci"><span class="icon">💰</span><span class="label">Płatności</span></button>
        <button class="nav-button" data-page="zdrowie"><span class="icon">❤️</span><span class="label">Zdrowie</span></button>
        <button class="nav-button" data-page="posilki"><span class="icon">🍴</span><span class="label">Posiłki</span></button>
        <button class="nav-button" data-page="checklista"><span class="icon">📋</span><span class="label">Checklista</span></button>
        <button class="nav-button" data-page="pomysly"><span class="icon">💡</span><span class="label">Pomysły</span></button>
        <button class="nav-button" data-page="cele"><span class="icon">🌱</span><span class="label">Cele</span></button>
        <button class="nav-button" data-page="notatnik"><span class="icon">📝</span><span class="label">Notatnik</span></button>
    </nav>
    
    <button id="exit-zen-btn" title="Wyjdź z Trybu Zen">👁️</button>

    <div id="task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="task-modal-title">Nowe zadanie</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="task-form">
                <input type="hidden" id="task-id">
                <div class="form-group">
                    <label for="task-name">Nazwa zadania</label>
                    <input type="text" id="task-name" required>
                </div>
                 <div class="form-group">
                    <label for="task-date">Termin (opcjonalnie)</label>
                    <input type="date" id="task-date">
                </div>
                <div class="form-group">
                    <label for="task-quadrant">Kwadrant</label>
                    <select id="task-quadrant">
                        <option value="1">🔴 Pilne i Ważne</option>
                        <option value="2">🟠 Ważne, niepilne</option>
                        <option value="3">🟡 Pilne, nieważne</option>
                        <option value="4">⚪ Ani pilne, ani ważne</option>
                    </select>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="task-delegated">
                    <label for="task-delegated">Zadanie do delegowania</label>
                </div>
                <div class="form-actions">
                    <button type="button" id="delete-task-btn" style="display: none;">🗑️</button>
                    <button type="submit">🩷</button>
                </div>
            </form>
        </div>
    </div>
    <div id="payment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nowa płatność</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="payment-form">
                <input type="hidden" id="payment-id">
                <div class="form-group">
                    <label for="payment-name">Dostawca / Nazwa</label>
                    <input type="text" id="payment-name" required>
                </div>
                <div class="form-group">
                    <label for="payment-amount">Kwota</label>
                    <input type="number" id="payment-amount" step="0.01" required>
                </div>
                 <div class="form-group">
                    <label for="payment-date">Termin</label>
                    <input type="date" id="payment-date" required>
                </div>
                 <div class="form-group">
                    <label for="payment-status">Status</label>
                    <select id="payment-status">
                        <option value="unpaid">Do zapłaty</option>
                        <option value="paid">Opłacona</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" id="delete-payment-btn" style="display: none;">🗑️</button>
                    <button type="submit">🩷</button>
                </div>
            </form>
        </div>
    </div>
    <div id="idea-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nowy pomysł</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="idea-form">
                <input type="hidden" id="idea-id">
                <div class="form-group">
                    <label for="idea-text">Twój pomysł</label>
                    <textarea id="idea-text" rows="3" required></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" id="delete-idea-btn" style="display: none;">🗑️</button>
                    <button type="submit">🩷</button>
                </div>
            </form>
        </div>
    </div>
    <div id="health-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nowy wpis zdrowotny</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="health-form">
                 <input type="hidden" id="health-id">
                 <div class="form-group">
                    <label for="health-date">Data wizyty</label>
                    <input type="date" id="health-date" required>
                </div>
                 <div class="form-group">
                    <label for="health-time">Godzina wizyty (opcjonalnie)</label>
                    <input type="time" id="health-time">
                </div>
                <div class="form-group">
                    <label for="health-mood">Nastrój (1-5)</label>
                    <input type="number" id="health-mood" min="1" max="5" value="3" required>
                </div>
                <div class="form-group">
                    <label for="health-person">Dla kogo wizyta?</label>
                    <select id="health-person">
                        <option value="Karolina">Karolina</option>
                        <option value="Tomek">Tomek</option>
                        <option value="Zosia">Zosia</option>
                        <option value="Tymek">Tymek</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="health-appointment">Opis wizyty (np. Kardiolog)</label>
                    <input type="text" id="health-appointment" placeholder="np. Kardiolog, kontrola">
                </div>
                 <div class="form-group">
                    <label for="health-notes">Notatki (np. waga, ciśnienie)</label>
                    <textarea id="health-notes" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" id="delete-health-btn" style="display: none;">🗑️</button>
                    <button type="submit">🩷</button>
                </div>
            </form>
        </div>
    </div>
    <div id="sync-modal" class="modal">
        <div class="modal-content">
             <div class="modal-header">
                <h3 class="modal-title">Synchronizacja i Kopia Zapasowa</h3>
                <button class="close-modal">&times;</button>
            </div>
            <p>Użyj poniższych opcji, aby zapisać swoje dane lub przenieść je między urządzeniami.</p>
            <button id="export-json-btn" class="btn">Eksportuj Kopię Zapasową</button>
            <input type="file" id="import-json-input" style="display: none;">
            <button id="import-json-btn" class="btn">Importuj Kopię Zapasową</button>
            <hr>
            <p>Pokaż kod QR na jednym urządzeniu i zeskanuj go na drugim (funkcja wkrótce).</p>
            <div id="qr-code-container"></div>
            <button id="generate-qr-btn" class="btn">Generuj QR</button>
        </div>
    </div>
    <div id="alert-modal" class="modal">
        <div class="modal-content">
             <div class="modal-header">
                <h3 class="modal-title" id="alert-title">Powiadomienie</h3>
                <button class="close-modal">&times;</button>
            </div>
            <p id="alert-message"></p>
        </div>
    </div>
    <div id="focus-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Czas na skupienie!</h3>
            <div id="focus-timer">25:00</div>
            <div class="form-actions" style="justify-content: center;">
                <button id="focus-start-stop" class="btn">Start</button>
                <button id="focus-close" class="btn">Zamknij</button>
            </div>
        </div>
    </div>
    <div id="goal-modal" class="modal">
        <div class="modal-content">
             <div class="modal-header">
                <h3 class="modal-title">Nowy Cel</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="goal-form">
                <input type="hidden" id="goal-id">
                <div class="form-group">
                    <label for="goal-name">Nazwa celu</label>
                    <input type="text" id="goal-name" required placeholder="np. Rozwinąć sprzedaż w sklepie">
                </div>
                <div class="form-group">
                    <label for="goal-steps-input">Kroki do celu (jeden na linię)</label>
                    <textarea id="goal-steps-input" rows="5" placeholder="np. Analiza konkurencji..."></textarea>
                </div>
                 <div class="form-actions">
                    <button type="button" id="delete-goal-btn" style="display: none;">🗑️</button>
                    <button type="submit">🩷</button>
                </div>
            </form>
        </div>
    </div>
    <div id="weekly-review-modal" class="modal">
         <div class="modal-content">
             <div class="modal-header">
                <h3 class="modal-title">📝 Podsumowanie Tygodnia</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="weekly-review-content"></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
    
        // =================================================================================
        // == APLIKACJA GŁÓWNA (app.js) ==
        // =================================================================================
        const app = {
            state: {
                theme: 'light',
                tasks: [],
                payments: [],
                health: [],
                ideas: [],
                goals: [],
                wins: {},
                meals: { shoppingList: '' },
                checklist: { date: '', items: [] }, 
                notebook: '',
            },
            
            init() {
                this.loadState();
                this.applyTheme();
                this.setupEventListeners();
                this.renderAll();
                this.requestNotificationPermission();
            },
            
            loadState() {
                const savedState = localStorage.getItem('appState');
                if (savedState) {
                    const defaultState = JSON.parse(JSON.stringify(this.state));
                    this.state = Object.assign(defaultState, JSON.parse(savedState));
                }
            },
            
            saveState() {
                localStorage.setItem('appState', JSON.stringify(this.state));
            },
            
            renderAll() {
                pulpit.render();
                tasks.render();
                payments.render();
                health.render();
                ideas.render();
                growth.render();
                meals.render();
                checklist.render();
                notebook.render();
            },

            applyTheme() {
                if (this.state.theme === 'dark') {
                    document.body.classList.add('dark-mode');
                    document.getElementById('theme-toggle').textContent = '☀️';
                } else {
                    document.body.classList.remove('dark-mode');
                     document.getElementById('theme-toggle').textContent = '🌙';
                }
            },
            
            toggleTheme() {
                this.state.theme = this.state.theme === 'light' ? 'dark' : 'light';
                this.applyTheme();
                this.saveState();
            },

            // ZMIANA: Dodano funkcję do Trybu Zen
            toggleZenMode() {
                document.body.classList.toggle('zen-mode');
            },

            navigateTo(pageId) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
                document.querySelector(`.nav-button[data-page="${pageId}"]`).classList.add('active');
            },

            showModal(modalId) { document.getElementById(modalId).classList.add('visible'); },
            hideModal(modalId) { document.getElementById(modalId).classList.remove('visible'); },
            
            showAlert(title, message) {
                document.getElementById('alert-title').textContent = title;
                document.getElementById('alert-message').textContent = message;
                this.showModal('alert-modal');
            },
            
            requestNotificationPermission() {
                if ('Notification' in window && Notification.permission !== 'granted') {
                    Notification.requestPermission();
                }
            },
            
            sendNotification(title, body) {
                 if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(title, { body: body, icon: './icon.png' });
                 }
            },

            setupEventListeners() {
                document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());
                // ZMIANA: Listener dla Trybu Zen
                document.getElementById('zen-mode-btn').addEventListener('click', () => this.toggleZenMode());
                document.getElementById('exit-zen-btn').addEventListener('click', () => this.toggleZenMode());

                document.querySelector('.nav-bar').addEventListener('click', (e) => {
                    const button = e.target.closest('.nav-button');
                    if (button) this.navigateTo(button.dataset.page);
                });
                document.querySelectorAll('.modal .close-modal, .modal').forEach(el => {
                    el.addEventListener('click', e => {
                        if (e.target === el) this.hideModal(el.closest('.modal').id);
                    });
                });
                document.getElementById('add-task-btn').addEventListener('click', () => tasks.showEditModal());
                document.getElementById('add-payment-btn').addEventListener('click', () => payments.showEditModal());
                document.getElementById('add-idea-btn').addEventListener('click', () => ideas.showEditModal());
                document.getElementById('add-health-btn').addEventListener('click', () => health.showEditModal());
                document.getElementById('add-goal-btn').addEventListener('click', () => growth.showGoalModal());
                document.getElementById('task-form').addEventListener('submit', (e) => tasks.handleSubmit(e));
                document.getElementById('payment-form').addEventListener('submit', (e) => payments.handleSubmit(e));
                document.getElementById('idea-form').addEventListener('submit', (e) => ideas.handleSubmit(e));
                document.getElementById('health-form').addEventListener('submit', (e) => health.handleSubmit(e));
                document.getElementById('add-win-form').addEventListener('submit', (e) => pulpit.addWin(e));
                document.getElementById('add-checklist-form').addEventListener('submit', (e) => checklist.addItem(e));
                document.getElementById('goal-form').addEventListener('submit', (e) => growth.handleGoalSubmit(e));
                document.getElementById('delete-task-btn').addEventListener('click', () => tasks.handleDelete());
                document.getElementById('delete-payment-btn').addEventListener('click', () => payments.handleDelete());
                document.getElementById('delete-idea-btn').addEventListener('click', () => ideas.handleDelete());
                document.getElementById('delete-health-btn').addEventListener('click', () => health.handleDelete());
                document.getElementById('delete-goal-btn').addEventListener('click', () => growth.handleGoalDelete());
                document.getElementById('sync-button').addEventListener('click', () => this.showModal('sync-modal'));
                document.getElementById('export-json-btn').addEventListener('click', () => this.exportJSON());
                document.getElementById('import-json-btn').addEventListener('click', () => document.getElementById('import-json-input').click());
                document.getElementById('import-json-input').addEventListener('change', (e) => this.importJSON(e));
                document.getElementById('generate-qr-btn').addEventListener('click', () => this.generateQR());
                document.getElementById('focus-btn').addEventListener('click', () => focusMode.show());
                document.getElementById('weekly-review-btn').addEventListener('click', () => weeklyReview.show());
                document.getElementById('shopping-list').addEventListener('input', (e) => meals.saveShoppingList(e.target.value));
                document.getElementById('group-shopping-list-btn').addEventListener('click', () => meals.groupShoppingList());
                document.getElementById('notebook-area').addEventListener('input', () => notebook.save());
                document.getElementById('notebook-sorter-btn').addEventListener('click', () => notebook.sort());
                // ZMIANA: Listener dla synchronizacji z kalendarzem (placeholdery)
                document.getElementById('sync-tasks-gcal-btn').addEventListener('click', () => this.showAlert('Synchronizacja (Demo)', 'W docelowej wersji tutaj nastąpiłaby synchronizacja zadań z Kalendarzem Google.'));
                document.getElementById('sync-health-gcal-btn').addEventListener('click', () => this.showAlert('Synchronizacja (Demo)', 'W docelowej wersji tutaj nastąpiłaby synchronizacja wizyt z Kalendarzem Google.'));
                // Eventy dla Pomodoro
                document.getElementById('focus-start-stop').addEventListener('click', () => focusMode.toggle());
                document.getElementById('focus-close').addEventListener('click', () => focusMode.hide());
            },
            
            exportJSON() {
                const dataStr = JSON.stringify(this.state);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'wezsiedoroboty-kopia.json';
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            },
            
            importJSON(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedState = JSON.parse(e.target.result);
                        if (importedState.tasks && importedState.theme) {
                            this.state = Object.assign(app.state, importedState);
                            this.saveState();
                            this.applyTheme();
                            this.renderAll();
                            this.showAlert('Sukces', 'Kopia zapasowa została wczytana.');
                        } else { throw new Error('Nieprawidłowy format pliku.'); }
                    } catch (error) { this.showAlert('Błąd', 'Nie udało się wczytać kopii zapasowej.'); }
                    finally { this.hideModal('sync-modal'); }
                };
                reader.readAsText(file);
            },
            
            generateQR() {
                const dataStr = JSON.stringify(this.state);
                const qrContainer = document.getElementById('qr-code-container');
                qrContainer.innerHTML = '';
                new QRious({ element: qrContainer, value: dataStr, size: 200 });
                this.showAlert('Kod QR', 'Funkcja skanowania QR jest w przygotowaniu.');
            }
        };

        // =================================================================================
        // == Komponent: PULPIT ==
        // =================================================================================
        const pulpit = {
            mottos: ["Jesteś architektem swojego dnia.", "Mały postęp to wciąż postęp.", "Energia podąża za uwagą.", "Zrobione jest lepsze od doskonałego.", "Pamiętaj, dlaczego zaczęłaś.", "Każda podróż zaczyna się od jednego kroku.", "Działaj, zamiast tylko marzyć."],
            dailyGoalProposals: ["Znajdź i zapisz jeden ciekawy artykuł na temat AI.", "Poświęć 20 minut na naukę nowego zagadnienia z UX/UI.", "Przeanalizuj ścieżkę użytkownika w konkurencyjnym sklepie.", "Zaprojektuj w Figmie jeden mały komponent (np. przycisk, karta produktu).", "Napisz krótki, angażujący tekst do nowego posta w mediach społecznościowych.", "Sprawdź statystyki swojego sklepu i zanotuj jeden kluczowy wniosek."],
            strategicGoals: ["UX/UI: Przeanalizuj 1 stronę konkurencji pod kątem użyteczności.", "AI: Poświęć 15 minut na artykuł o nowościach w AI.", "WWW: Naucz się jednej nowej właściwości CSS i zastosuj ją w praktyce.", "UX/UI: Naszkicuj przepływ dla nowej funkcji w aplikacji.", "AI: Przetestuj jedno narzędzie AI do generowania grafik lub tekstu."],
            kpiGoals: ["HappyKiddy: Sprawdź statystyki odwiedzin z ostatniego tygodnia.", "HappyKiddy: Odpisz na wszystkie komentarze i wiadomości.", "Marketing: Zaplanuj 1 angażujący post na Instagram.", "Marketing: Wymyśl chwytliwe hasło do nowej kampanii promocyjnej.", "HappyKiddy: Zoptymalizuj opisy 2 produktów w sklepie pod SEO."],
            selfCareIdeas: ["Zaparz ulubioną herbatę i wypij ją w całkowitej ciszy.", "Włącz ulubioną piosenkę i potańcz przez 3 minuty.", "Wyjdź na 5-minutowy spacer i skup się na oddechu.", "Poczytaj książkę (niezwiązaną z pracą) przez 10 minut.", "Zrób sobie krótki masaż dłoni nawilżającym kremem.", "Zamknij oczy na minutę i nie myśl o niczym."],
            cleaningMotivators: ["Uporządkuj swoje biurko – czysta przestrzeń to czysty umysł.", "Wyrzuć 5 niepotrzebnych rzeczy ze swojego otoczenia.", "Pościel łóżko – to małe zwycięstwo na początek dnia.", "Umyj naczynia od razu po posiłku, nie odkładaj na później.", "Przetrzyj ekran telefonu i laptopa.", "Odkurz w jednym, wybranym pomieszczeniu."],

            render() {
                const today = new Date().toDateString();
                let dailyData = JSON.parse(localStorage.getItem('dailyPulpitData'));
                if (!dailyData || dailyData.date !== today) {
                    dailyData = {
                        date: today,
                        motto: this.getRandomItem(this.mottos),
                        dailyGoal: this.getRandomItem(this.dailyGoalProposals),
                        strategicGoal: this.getRandomItem(this.strategicGoals),
                        kpiGoal: this.getRandomItem(this.kpiGoals),
                        selfCare: this.getRandomItem(this.selfCareIdeas),
                        cleaning: this.getRandomItem(this.cleaningMotivators)
                    };
                    localStorage.setItem('dailyPulpitData', JSON.stringify(dailyData));
                }
                document.getElementById('daily-motto').textContent = dailyData.motto;
                document.getElementById('daily-goal-proposal').textContent = dailyData.dailyGoal;
                document.getElementById('strategic-goals').textContent = dailyData.strategicGoal;
                document.getElementById('kpi-goals').textContent = dailyData.kpiGoal;
                document.getElementById('self-care-idea').textContent = dailyData.selfCare;
                document.getElementById('cleaning-motivator').textContent = dailyData.cleaning;
                this.renderPriorities();
                this.renderUrgentItems();
                this.renderWins();
            },
            getRandomItem(arr) { return arr[Math.floor(Math.random() * arr.length)]; },
            renderPriorities() {
                const list = document.getElementById('daily-priorities');
                list.innerHTML = '';
                const priorityTasks = app.state.tasks.filter(t => !t.completed && (t.quadrant == 1 || t.quadrant == 2)).slice(0, 3);
                if (priorityTasks.length > 0) priorityTasks.forEach(task => list.innerHTML += `<p>• ${task.name}</p>`);
                else list.innerHTML = '<p>Brak ważnych zadań.</p>';
            },
            renderUrgentItems() {
                const paymentsContainer = document.getElementById('urgent-payments');
                const appointmentsContainer = document.getElementById('upcoming-appointments');
                paymentsContainer.innerHTML = '<p>Brak.</p>';
                appointmentsContainer.innerHTML = '<p>Brak.</p>';
                const today = new Date(); today.setHours(0, 0, 0, 0);
                const twoDaysFromNow = new Date(today); twoDaysFromNow.setDate(today.getDate() + 2);
                const urgentPayments = app.state.payments.filter(p => {
                    const paymentDate = new Date(p.date);
                    return p.status !== 'paid' && paymentDate >= today && paymentDate <= twoDaysFromNow;
                });
                if (urgentPayments.length > 0) {
                    paymentsContainer.innerHTML = '';
                    urgentPayments.forEach(p => paymentsContainer.innerHTML += `<p>${p.name} - ${p.amount} zł</p>`);
                }
                const upcomingAppointments = app.state.health.filter(h => {
                    if (!h.appointment) return false;
                    const appointmentDate = new Date(h.date);
                    return appointmentDate >= today && appointmentDate <= twoDaysFromNow;
                });
                if (upcomingAppointments.length > 0) {
                    appointmentsContainer.innerHTML = '';
                    upcomingAppointments.forEach(h => {
                        const personLabel = `<span class="person-label person-${h.person || 'Karolina'}">${h.person || 'Brak'}</span>`;
                        appointmentsContainer.innerHTML += `<p>${personLabel} ${h.appointment} - ${h.date}</p>`;
                    });
                }
            },
            renderWins() {
                const list = document.getElementById('wins-list');
                list.innerHTML = '<li>Doceniaj małe sukcesy!</li>';
                const todayKey = new Date().toISOString().slice(0, 10);
                const todaysWins = app.state.wins[todayKey] || [];
                if (todaysWins.length > 0) {
                    list.innerHTML = '';
                    todaysWins.forEach(win => list.innerHTML += `<li>${win}</li>`);
                }
            },
            addWin(e) {
                e.preventDefault();
                const input = document.getElementById('win-input');
                const winText = input.value.trim();
                if (!winText) return;
                const todayKey = new Date().toISOString().slice(0, 10);
                if (!app.state.wins[todayKey]) app.state.wins[todayKey] = [];
                app.state.wins[todayKey].push(winText);
                app.saveState();
                this.renderWins();
                input.value = '';
            }
        };

        // =================================================================================
        // == Komponent: ZADANIA ==
        // =================================================================================
        const tasks = {
            draggedItem: null,
            render() {
                document.querySelectorAll('.task-list').forEach(list => list.innerHTML = '');
                app.state.tasks.forEach(task => {
                    const taskEl = this.createTaskElement(task);
                    document.querySelector(`#q${task.quadrant} .task-list`).appendChild(taskEl);
                });
                this.setupDragAndDrop();
            },
            createTaskElement(task) {
                const div = document.createElement('div');
                div.className = 'task';
                if (task.delegated) div.classList.add('delegated');
                if (task.completed) div.classList.add('completed');
                div.draggable = true;
                div.dataset.id = task.id;
                const dateHTML = task.date ? `<span class="task-date">${task.date}</span>` : '';
                const calendarBtn = task.date ? `<button class="btn" style="padding:0;font-size:1rem;background:none;" onclick="tasks.addToCalendar('${task.id}')">🗓️</button>` : '';
                div.innerHTML = `
                    <div class="checkbox-group" style="flex-grow: 1; align-items: flex-start; flex-direction: column;">
                         <div style="display:flex; align-items: center; width: 100%;">
                             <input type="checkbox" id="cb-${task.id}" ${task.completed ? 'checked' : ''} style="margin-right: 0.5rem;">
                             <label for="cb-${task.id}" style="flex-grow: 1;"><span>${task.name} ${task.delegated ? '🤝' : ''}</span></label>
                         </div>
                         ${dateHTML}
                    </div>
                    <div class="task-actions" style="display:flex; align-items:center;">
                        ${calendarBtn}
                        <button class="edit-task">✏️</button>
                    </div>`;
                div.querySelector('.edit-task').addEventListener('click', (e) => { e.stopPropagation(); this.showEditModal(task.id); });
                div.querySelector(`#cb-${task.id}`).addEventListener('change', () => this.toggleCompleted(task.id));
                return div;
            },
            toggleCompleted(id) {
                const task = app.state.tasks.find(t => t.id === id);
                if(task) {
                    task.completed = !task.completed;
                    if(task.completed) {
                        const winText = `Ukończono zadanie: ${task.name}`;
                        const todayKey = new Date().toISOString().slice(0, 10);
                        if (!app.state.wins[todayKey]) app.state.wins[todayKey] = [];
                        if(!app.state.wins[todayKey].includes(winText)) app.state.wins[todayKey].push(winText);
                    }
                    app.saveState(); this.render(); pulpit.render();
                }
            },
            showEditModal(id) {
                const form = document.getElementById('task-form');
                form.reset();
                document.getElementById('task-id').value = id || '';
                const deleteBtn = document.getElementById('delete-task-btn');
                if (id) {
                    const task = app.state.tasks.find(t => t.id === id);
                    document.getElementById('task-modal-title').textContent = 'Edytuj zadanie';
                    document.getElementById('task-name').value = task.name;
                    document.getElementById('task-date').value = task.date || '';
                    document.getElementById('task-quadrant').value = task.quadrant;
                    document.getElementById('task-delegated').checked = task.delegated || false;
                    deleteBtn.style.display = 'inline-block';
                } else {
                    document.getElementById('task-modal-title').textContent = 'Nowe zadanie';
                    deleteBtn.style.display = 'none';
                }
                app.showModal('task-modal');
            },
            handleSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('task-id').value;
                const data = {
                    name: document.getElementById('task-name').value,
                    date: document.getElementById('task-date').value,
                    quadrant: document.getElementById('task-quadrant').value,
                    delegated: document.getElementById('task-delegated').checked
                };
                if (id) {
                    const task = app.state.tasks.find(t => t.id === id);
                    Object.assign(task, data);
                } else {
                    app.state.tasks.push({ id: `task-${Date.now()}`, ...data, completed: false });
                }
                app.saveState(); this.render(); pulpit.render(); app.hideModal('task-modal');
            },
            handleDelete() {
                const id = document.getElementById('task-id').value;
                app.state.tasks = app.state.tasks.filter(t => t.id !== id);
                app.saveState(); this.render(); pulpit.render(); app.hideModal('task-modal');
            },
            addToCalendar(id) {
                const task = app.state.tasks.find(t => t.id === id);
                if (!task || !task.date) return;
                const startDate = new Date(task.date);
                const icsContent = ['BEGIN:VCALENDAR', 'VERSION:2.0', 'BEGIN:VEVENT', `SUMMARY:Zadanie: ${task.name}`, `DTSTART;VALUE=DATE:${task.date.replace(/-/g, '')}`, `DTEND;VALUE=DATE:${new Date(startDate.getTime() + 24 * 3600 * 1000).toISOString().slice(0, 10).replace(/-/g, '')}`, 'END:VEVENT', 'END:VCALENDAR'].join('\n');
                const blob = new Blob([icsContent], { type: 'text/calendar' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `zadanie_${task.name.replace(/\s/g, '_')}.ics`;
                link.click();
            },
            setupDragAndDrop() {
                document.querySelectorAll('.task').forEach(taskEl => {
                    taskEl.addEventListener('dragstart', (e) => {
                         if(e.target.matches('.task')) { this.draggedItem = e.target; setTimeout(() => e.target.classList.add('dragging'), 0); }
                    });
                    taskEl.addEventListener('dragend', () => { if(this.draggedItem) this.draggedItem.classList.remove('dragging'); this.draggedItem = null; });
                });
                document.querySelectorAll('.quadrant').forEach(quadrant => {
                    quadrant.addEventListener('dragover', e => e.preventDefault());
                    quadrant.addEventListener('drop', e => {
                        e.preventDefault();
                        const targetQuadrant = e.target.closest('.quadrant');
                        if (!targetQuadrant || !this.draggedItem) return;
                        const draggedId = this.draggedItem.dataset.id;
                        const newQuadrantId = targetQuadrant.dataset.quadrant;
                        let task;
                        if (draggedId.startsWith('task-')) { task = app.state.tasks.find(t => t.id === draggedId); }
                        else {
                             let name;
                             if (draggedId.startsWith('idea-')) {
                                const idea = app.state.ideas.find(i => i.id === draggedId);
                                name = idea.text; app.state.ideas = app.state.ideas.filter(i => i.id !== draggedId); ideas.render();
                             } else {
                                const payment = app.state.payments.find(p => p.id === draggedId);
                                name = `Zapłać: ${payment.name} (${payment.amount} zł)`;
                             }
                             task = { id: `task-${Date.now()}`, name, quadrant: newQuadrantId, completed: false };
                             app.state.tasks.push(task);
                        }
                        if (task) task.quadrant = newQuadrantId;
                        app.saveState(); this.render();
                    });
                });
            }
        };

        // =================================================================================
        // == Komponent: PŁATNOŚCI ==
        // =================================================================================
        const payments = {
            render() {
                const list = document.getElementById('payments-list');
                list.innerHTML = '<p>Brak płatności na liście.</p>';
                if(app.state.payments.length === 0) return;
                list.innerHTML = '';
                const sorted = [...app.state.payments].sort((a,b) => new Date(a.date) - new Date(b.date));
                sorted.forEach(p => {
                    const item = document.createElement('div');
                    item.className = 'payment-item';
                    item.dataset.id = p.id;
                    const daysDiff = (new Date(p.date) - new Date()) / (1000 * 3600 * 24);
                    let statusClass = 'status-pending', statusText = 'Oczekuje';
                    if (p.status === 'paid') { statusClass = 'status-paid'; statusText = 'Opłacona'; }
                    else if (daysDiff < 0) { statusClass = 'status-overdue'; statusText = 'Zaległa'; }
                    else if (daysDiff <= 7) { statusClass = 'status-approaching'; statusText = 'Zbliża się'; }
                    item.innerHTML = `<div><span>${p.name} - <strong>${p.amount} zł</strong> (do ${p.date})</span><span class="payment-status ${statusClass}">${statusText}</span></div><button class="edit-payment">✏️</button>`;
                    item.querySelector('.edit-payment').addEventListener('click', () => this.showEditModal(p.id));
                    list.appendChild(item);
                });
            },
            showEditModal(id) {
                const form = document.getElementById('payment-form'), deleteBtn = document.getElementById('delete-payment-btn');
                form.reset(); document.getElementById('payment-id').value = id || '';
                if (id) {
                    const p = app.state.payments.find(p => p.id === id);
                    document.getElementById('payment-name').value = p.name;
                    document.getElementById('payment-amount').value = p.amount;
                    document.getElementById('payment-date').value = p.date;
                    document.getElementById('payment-status').value = p.status || 'unpaid';
                    deleteBtn.style.display = 'inline-block';
                } else { deleteBtn.style.display = 'none'; }
                app.showModal('payment-modal');
            },
            handleSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('payment-id').value, name = document.getElementById('payment-name').value, amount = document.getElementById('payment-amount').value, date = document.getElementById('payment-date').value, status = document.getElementById('payment-status').value;
                if (id) { Object.assign(app.state.payments.find(p => p.id === id), { name, amount, date, status }); }
                else { app.state.payments.push({ id: `payment-${Date.now()}`, name, amount, date, status }); app.sendNotification('Nowa płatność', `Pamiętaj o terminie za ${name} do ${date}.`);}
                app.saveState(); this.render(); pulpit.render(); app.hideModal('payment-modal');
            },
            handleDelete() {
                const id = document.getElementById('payment-id').value;
                app.state.payments = app.state.payments.filter(p => p.id !== id);
                app.saveState(); this.render(); pulpit.render(); app.hideModal('payment-modal');
            }
        };

        // =================================================================================
        // == Komponent: ZDROWIE ==
        // =================================================================================
        const health = {
             render() {
                const list = document.getElementById('health-list');
                list.innerHTML = '<p>Brak wpisów.</p>';
                if (app.state.health.length === 0) return;
                list.innerHTML = '';
                
                const today = new Date(); today.setHours(0,0,0,0);
                const upcoming = app.state.health.filter(h => new Date(h.date) >= today).sort((a,b) => new Date(a.date) - new Date(b.date));
                const past = app.state.health.filter(h => new Date(h.date) < today).sort((a,b) => new Date(b.date) - new Date(a.date));
                
                if (upcoming.length > 0) list.innerHTML += `<h3>Nadchodzące</h3>`;
                upcoming.forEach((h, index) => {
                    const item = this.createHealthItem(h);
                    if(index === 0) item.classList.add('next-appointment');
                    list.appendChild(item);
                });
                
                if (past.length > 0) list.innerHTML += `<h3>Archiwum</h3>`;
                past.forEach(h => list.appendChild(this.createHealthItem(h)));
            },
            createHealthItem(h) {
                let appointmentHTML = '';
                if (h.appointment && h.appointment.trim() !== '') {
                    const personLabel = `<span class="person-label person-${h.person || 'Karolina'}">${h.person || 'Brak'}</span>`;
                    const calendarBtn = `<button class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;" onclick="health.addToCalendar('${h.id}')">🗓️</button>`;
                    appointmentHTML = `<div class="appointment-details">${personLabel}<span class="appointment-info">🩺 ${h.appointment} o ${h.time || ''}</span>${calendarBtn}</div>`;
                }
                const notesHTML = (h.notes && h.notes.trim() !== '') ? `<p class="health-notes">${h.notes}</p>` : '';
                const item = document.createElement('div');
                item.className = 'health-item';
                item.innerHTML = `<div class="health-content">${appointmentHTML}<div class="mood-details"><strong>Nastrój: ${'😊'.repeat(h.mood)}</strong> (${new Date(h.date).toLocaleDateString('pl-PL')})</div>${notesHTML}</div><button class="edit-health">✏️</button>`;
                item.querySelector('.edit-health').addEventListener('click', () => this.showEditModal(h.id));
                return item;
            },
            showEditModal(id) {
                const form = document.getElementById('health-form'), deleteBtn = document.getElementById('delete-health-btn');
                form.reset(); document.getElementById('health-id').value = id || '';
                if (id) {
                    const h = app.state.health.find(h => h.id === id);
                    document.getElementById('health-date').value = h.date;
                    document.getElementById('health-time').value = h.time || '';
                    document.getElementById('health-mood').value = h.mood;
                    document.getElementById('health-person').value = h.person || 'Karolina';
                    document.getElementById('health-appointment').value = h.appointment || '';
                    document.getElementById('health-notes').value = h.notes || '';
                    deleteBtn.style.display = 'inline-block';
                } else { document.getElementById('health-date').valueAsDate = new Date(); deleteBtn.style.display = 'none'; }
                app.showModal('health-modal');
            },
            handleSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('health-id').value;
                const data = { date: document.getElementById('health-date').value, time: document.getElementById('health-time').value, mood: document.getElementById('health-mood').value, person: document.getElementById('health-person').value, appointment: document.getElementById('health-appointment').value, notes: document.getElementById('health-notes').value };
                if (id) { Object.assign(app.state.health.find(h => h.id === id), data); }
                else { app.state.health.push({ id: `health-${Date.now()}`, ...data }); }
                app.saveState(); this.render(); pulpit.render(); app.hideModal('health-modal');
            },
            handleDelete() {
                const id = document.getElementById('health-id').value;
                app.state.health = app.state.health.filter(h => h.id !== id);
                app.saveState(); this.render(); pulpit.render(); app.hideModal('health-modal');
            },
            addToCalendar(id) {
                const h = app.state.health.find(h => h.id === id);
                if (!h || !h.appointment) return;
                const [year, month, day] = h.date.split('-');
                const [hour, minute] = (h.time || '00:00').split(':');
                const startDate = new Date(Date.UTC(year, month - 1, day, hour, minute));
                const endDate = new Date(startDate.getTime() + 60 * 60 * 1000);
                const toICSFormat = (date) => date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                const icsContent = ['BEGIN:VCALENDAR', 'VERSION:2.0', 'BEGIN:VEVENT', `SUMMARY:Wizyta: ${h.appointment} (${h.person})`, `DTSTART:${toICSFormat(startDate)}`, `DTEND:${toICSFormat(endDate)}`, 'END:VEVENT', 'END:VCALENDAR'].join('\n');
                const blob = new Blob([icsContent], { type: 'text/calendar' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob); link.download = `wizyta_${h.person}.ics`; link.click();
            }
        };

        // =================================================================================
        // == Komponent: POMYSŁY ==
        // =================================================================================
        const ideas = {
            render() {
                const list = document.getElementById('ideas-list');
                list.innerHTML = '<p>Głowa pusta? Czas na kawę!</p>';
                if(app.state.ideas.length === 0) return;
                list.innerHTML = '';
                app.state.ideas.forEach(idea => {
                    const item = document.createElement('div');
                    item.className = 'idea-item task'; item.draggable = true; item.dataset.id = idea.id;
                    item.innerHTML = `<span>${idea.text}</span><button class="edit-idea">✏️</button>`;
                    item.querySelector('.edit-idea').addEventListener('click', () => this.showEditModal(idea.id));
                    list.appendChild(item);
                });
                tasks.setupDragAndDrop();
            },
            showEditModal(id) {
                const form = document.getElementById('idea-form'), deleteBtn = document.getElementById('delete-idea-btn');
                form.reset(); document.getElementById('idea-id').value = id || '';
                if (id) { document.getElementById('idea-text').value = app.state.ideas.find(i => i.id === id).text; deleteBtn.style.display = 'inline-block'; }
                else { deleteBtn.style.display = 'none'; }
                app.showModal('idea-modal');
            },
            handleSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('idea-id').value, text = document.getElementById('idea-text').value;
                if (id) app.state.ideas.find(i => i.id === id).text = text;
                else app.state.ideas.push({ id: `idea-${Date.now()}`, text });
                app.saveState(); this.render(); app.hideModal('idea-modal');
            },
            handleDelete() {
                const id = document.getElementById('idea-id').value;
                app.state.ideas = app.state.ideas.filter(i => i.id !== id);
                app.saveState(); this.render(); app.hideModal('idea-modal');
            }
        };

        // =================================================================================
        // == Komponent: CELE (ZMIANA: Sugestie AI) ==
        // =================================================================================
        const growth = {
            render() {
                const list = document.getElementById('goals-list');
                list.innerHTML = '<p>Brak zdefiniowanych celów. Czas zacząć!</p>';
                if (app.state.goals.length === 0) return;
                list.innerHTML = '';
                app.state.goals.forEach(goal => {
                    const completedSteps = goal.steps.filter(s => s.completed).length;
                    const progress = (completedSteps / goal.steps.length) * 100 || 0;
                    const item = document.createElement('div'); item.className = 'goal-item';
                    let stepsHTML = goal.steps.map((step, index) => `
                        <div class="goal-step">
                           <input type="checkbox" id="gs-${goal.id}-${index}" ${step.completed ? 'checked' : ''} onchange="growth.toggleStep('${goal.id}', ${index})">
                           <label for="gs-${goal.id}-${index}">${step.text}</label>
                        </div>`).join('');
                    item.innerHTML = `<h4><span>${goal.name}</span> <div><button onclick="growth.getAISuggestions('${goal.id}')" title="Zaproponuj kroki z AI">🤖</button><button onclick="growth.showGoalModal('${goal.id}')">✏️</button></div></h4><progress value="${progress}" max="100"></progress><div>${stepsHTML}</div>`;
                    list.appendChild(item);
                });
            },
            showGoalModal(id) {
                const form = document.getElementById('goal-form'), deleteBtn = document.getElementById('delete-goal-btn');
                form.reset(); document.getElementById('goal-id').value = id || '';
                if (id) {
                    const goal = app.state.goals.find(g => g.id === id);
                    document.getElementById('goal-name').value = goal.name;
                    document.getElementById('goal-steps-input').value = goal.steps.map(s => s.text).join('\n');
                    deleteBtn.style.display = 'inline-block';
                } else { deleteBtn.style.display = 'none'; }
                app.showModal('goal-modal');
            },
            handleGoalSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('goal-id').value, name = document.getElementById('goal-name').value, stepsText = document.getElementById('goal-steps-input').value;
                if (id) {
                    const goal = app.state.goals.find(g => g.id === id);
                    goal.name = name;
                    goal.steps = stepsText.split('\n').filter(s => s.trim() !== '').map(text => {
                        const existingStep = goal.steps.find(s => s.text === text);
                        return existingStep || { text, completed: false };
                    });
                } else {
                    const steps = stepsText.split('\n').filter(s => s.trim() !== '').map(text => ({ text, completed: false }));
                    app.state.goals.push({ id: `goal-${Date.now()}`, name, steps });
                }
                app.saveState(); this.render(); app.hideModal('goal-modal');
            },
            handleGoalDelete() {
                const id = document.getElementById('goal-id').value;
                app.state.goals = app.state.goals.filter(g => g.id !== id);
                app.saveState(); this.render(); app.hideModal('goal-modal');
            },
            toggleStep(goalId, stepIndex) {
                const goal = app.state.goals.find(g => g.id === goalId);
                if (goal) { goal.steps[stepIndex].completed = !goal.steps[stepIndex].completed; app.saveState(); this.render(); }
            },
            // ZMIANA: Funkcja symulująca sugestie AI
            getAISuggestions(goalId) {
                const goal = app.state.goals.find(g => g.id === goalId);
                if (!goal) return;

                const suggestions = {
                    'sprzedaż|sklep|marketing': ["Analiza konkurencji", "Zaplanuj post promocyjny", "Zbierz opinie od 3 klientów", "Zoptymalizuj SEO dla jednego produktu"],
                    'nauka|kurs|rozwój|ux|ui|ai': ["Poświęć 30 minut na jeden moduł kursu", "Zrób szczegółowe notatki", "Wykonaj ćwiczenie praktyczne", "Napisz podsumowanie tego, czego się nauczyłaś"],
                    'zdrowie|forma|dieta': ["Zaplanuj posiłki na 3 dni", "Wykonaj 20-minutowy trening", "Idź na 30-minutowy spacer", "Pij 1.5l wody"],
                    'default': ["Podziel cel na 3 mniejsze kroki", "Określ pierwszy, najprostszy krok", "Znajdź zasoby potrzebne do realizacji celu"]
                };

                let suggestedSteps = suggestions.default;
                for (const key in suggestions) {
                    if (new RegExp(key, 'i').test(goal.name)) {
                        suggestedSteps = suggestions[key];
                        break;
                    }
                }

                const newStepsText = suggestedSteps.join('\n');
                const currentSteps = document.getElementById('goal-steps-input').value;
                if (confirm(`AI proponuje następujące kroki dla celu "${goal.name}":\n\n${newStepsText}\n\nCzy chcesz je dodać do istniejącej listy kroków?`)) {
                    this.showGoalModal(goal.id);
                    const textarea = document.getElementById('goal-steps-input');
                    textarea.value = (textarea.value.trim() === '' ? '' : textarea.value + '\n') + newStepsText;
                }
            }
        };

        // =================================================================================
        // == Pozostałe komponenty
        // =================================================================================
        const meals = {
            mealIdeas: { 
                breakfast: ['Owsianka z owocami i orzechami', 'Jajecznica na boczku ze szczypiorkiem', 'Kanapki z awokado, pomidorem i rukolą', 'Jogurt naturalny z granolą i miodem', 'Twarożek z rzodkiewką i ogórkiem', 'Smoothie bananowo-szpinakowe', 'Naleśniki z serem'], 
                lunch: ['Pierś z kurczaka z ryżem i brokułami', 'Zupa pomidorowa z makaronem', 'Sałatka grecka z grzankami', 'Makaron z pesto i kurczakiem', 'Leczo warzywne', 'Ryba na parze z ziemniakami i koperkiem', 'Zupa krem z dyni'], 
                dinner: ['Zapiekanka makaronowa z mięsem mielonym', 'Lekka sałatka z tuńczykiem', 'Wrapy z kurczakiem i warzywami', 'Omlet z szynką i serem', 'Kanapki na ciepło z pieczarkami', 'Sałatka z wędzonym łososiem', 'Krem z białych warzyw'] 
            },
            shoppingCategories: { 'Nabiał': ['mleko', 'ser', 'jajka', 'jogurt', 'masło', 'twaróg'], 'Warzywa': ['pomidor', 'ogórek', 'cebula', 'sałata', 'ziemniaki', 'marchew', 'brokuł', 'szpinak', 'papryka', 'dynia'], 'Owoce': ['banan', 'jabłko', 'cytryna', 'pomarańcza', 'awokado'], 'Mięso i Ryby': ['kurczak', 'szynka', 'boczek', 'indyk', 'mięso mielone', 'łosoś', 'tuńczyk'], 'Pieczywo': ['chleb', 'bułki', 'tortilla'], 'Produkty sypkie': ['ryż', 'makaron', 'kasza', 'mąka', 'cukier', 'granola'] },
            render() {
                const container = document.getElementById('daily-meal-ideas');
                const today = new Date().toDateString();
                let dailyMeals = JSON.parse(localStorage.getItem('dailyMeals'));
                if (!dailyMeals || dailyMeals.date !== today) {
                    dailyMeals = {
                        date: today,
                        breakfast: pulpit.getRandomItem(this.mealIdeas.breakfast),
                        lunch: pulpit.getRandomItem(this.mealIdeas.lunch),
                        dinner: pulpit.getRandomItem(this.mealIdeas.dinner)
                    };
                    localStorage.setItem('dailyMeals', JSON.stringify(dailyMeals));
                }
                 container.innerHTML = `
                    <p><strong>Śniadanie:</strong> ${dailyMeals.breakfast}</p>
                    <p><strong>Obiad:</strong> ${dailyMeals.lunch}</p>
                    <p><strong>Kolacja:</strong> ${dailyMeals.dinner}</p>
                `;
                document.getElementById('shopping-list').value = app.state.meals.shoppingList || '';
            },
            saveShoppingList(value) { app.state.meals.shoppingList = value; app.saveState(); },
            groupShoppingList() {
                const list = app.state.meals.shoppingList.toLowerCase().split('\n').filter(i => i.trim() !== '');
                const grouped = { 'Inne': [] };
                list.forEach(item => {
                    let found = false;
                    for (const category in this.shoppingCategories) {
                        if (this.shoppingCategories[category].some(keyword => item.includes(keyword))) {
                            if (!grouped[category]) grouped[category] = [];
                            grouped[category].push(item); found = true; break;
                        }
                    }
                    if (!found) grouped['Inne'].push(item);
                });
                const container = document.getElementById('grouped-shopping-list'); container.innerHTML = '';
                for (const category in grouped) {
                    if (grouped[category].length > 0) container.innerHTML += `<h4>${category}</h4><ul>${grouped[category].map(i => `<li>${i}</li>`).join('')}</ul>`;
                }
            }
        };
        const checklist = {
            render() {
                const todayKey = new Date().toISOString().slice(0, 10);
                if (app.state.checklist.date !== todayKey) {
                    app.state.checklist = { date: todayKey, items: [] };
                    app.saveState();
                }

                const list = document.getElementById('checklist-list');
                list.innerHTML = '';
                if(app.state.checklist.items.length === 0) {
                     list.innerHTML = '<p>Brak zadań na dzisiejszej checkliście.</p>';
                     return;
                }
                
                app.state.checklist.items.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'checklist-item' + (item.completed ? ' completed' : '');
                    div.innerHTML = `
                        <input type="checkbox" id="check-${index}" ${item.completed ? 'checked' : ''}>
                        <label for="check-${index}">${item.text}</label>
                    `;
                    div.querySelector('input').addEventListener('change', () => this.toggleComplete(index));
                    list.appendChild(div);
                });
            },
            addItem(e) {
                e.preventDefault();
                const input = document.getElementById('checklist-input');
                const text = input.value.trim();
                if (text) {
                    app.state.checklist.items.push({ text, completed: false });
                    app.saveState();
                    this.render();
                    input.value = '';
                }
            },
            toggleComplete(index) {
                app.state.checklist.items[index].completed = !app.state.checklist.items[index].completed;
                app.saveState();
                this.render();
            }
        };
        // ZMIANA: Rozbudowany Notatnik AI
        const notebook = {
            render() { document.getElementById('notebook-area').value = app.state.notebook || ''; },
            save() { app.state.notebook = document.getElementById('notebook-area').value; app.saveState(); },
            sort() {
                const text = app.state.notebook; 
                const lines = text.split('\n').filter(l => l.trim() !== '');
                if (lines.length === 0) return app.showAlert("Pusty notatnik", "Nie ma nic do posortowania. Wpisz coś najpierw!");

                const patterns = {
                    task: /zrobić|zadanie|zapłacić|umówić|wysłać/i,
                    shopping: /kupić|lista zakupów|na zakupy/i,
                    health: /wizyta|lekarz|badanie|recepta|zdrowie/i
                };

                const getRelativeDate = (line) => {
                    const d = new Date();
                    if (/jutro/i.test(line)) d.setDate(d.getDate() + 1);
                    if (/pojutrze/i.test(line)) d.setDate(d.getDate() + 2);
                    if (/poniedziałek|pon/i.test(line)) d.setDate(d.getDate() + (1 + 7 - d.getDay()) % 7);
                    if (/wtorek|wt/i.test(line)) d.setDate(d.getDate() + (2 + 7 - d.getDay()) % 7);
                    if (/środ[aę]|śr/i.test(line)) d.setDate(d.getDate() + (3 + 7 - d.getDay()) % 7);
                    if (/czwartek|czw/i.test(line)) d.setDate(d.getDate() + (4 + 7 - d.getDay()) % 7);
                    if (/piątek|pt/i.test(line)) d.setDate(d.getDate() + (5 + 7 - d.getDay()) % 7);
                    const timeMatch = line.match(/(\d{1,2}):(\d{2})/);
                    return { date: d.toISOString().slice(0, 10), time: timeMatch ? timeMatch[0] : '' };
                };

                const sorted = { tasks: [], ideas: [], health: [], shopping: [] };
                lines.forEach(line => {
                    if (patterns.health.test(line)) sorted.health.push(line);
                    else if (patterns.shopping.test(line)) sorted.shopping.push(line.replace(patterns.shopping, '').trim());
                    else if (patterns.task.test(line)) sorted.tasks.push(line);
                    else sorted.ideas.push(line);
                });

                let summary = `Asystent AI znalazł:\n`;
                if(sorted.tasks.length > 0) summary += `\n- ${sorted.tasks.length} potencjalnych zadań`;
                if(sorted.health.length > 0) summary += `\n- ${sorted.health.length} wpisów zdrowotnych`;
                if(sorted.shopping.length > 0) summary += `\n- ${sorted.shopping.length} produktów na listę zakupów`;
                if(sorted.ideas.length > 0) summary += `\n- ${sorted.ideas.length} pomysłów`;

                if(confirm(`${summary}\n\nCzy chcesz dodać je do odpowiednich sekcji i wyczyścić notatnik?`)) {
                    sorted.tasks.forEach(name => {
                        const { date } = getRelativeDate(name);
                        app.state.tasks.push({ id: `task-${Date.now()}`, name, date, quadrant: 4, completed: false });
                    });
                    sorted.ideas.forEach(text => app.state.ideas.push({ id: `idea-${Date.now()}`, text }));
                    sorted.health.forEach(line => {
                        const { date, time } = getRelativeDate(line);
                        const personMatch = line.match(/dla (Zosi|Tymka|Karoliny|Tomka)|(Zosi|Tymka|Karoliny|Tomka)/i);
                        const person = personMatch ? (personMatch[1] || personMatch[2]) : 'Karolina';
                        const appointment = line.replace(/u lekarza/i, '').trim();
                        app.state.health.push({ id: `health-${Date.now()}`, date, time, mood: 3, person, appointment, notes: '' });
                    });
                    if(sorted.shopping.length > 0) {
                        const currentList = app.state.meals.shoppingList.trim();
                        app.state.meals.shoppingList = (currentList === '' ? '' : currentList + '\n') + sorted.shopping.join('\n');
                    }
                    
                    app.state.notebook = '';
                    app.saveState(); app.renderAll();
                    app.showAlert("Gotowe!", "Notatki zostały inteligentnie posortowane.");
                }
            }
        };
        const focusMode = {
            timerInterval: null, timeLeft: 25 * 60, isRunning: false,
            show() { this.reset(); app.showModal('focus-modal'); },
            hide() { this.stop(); app.hideModal('focus-modal'); },
            toggle() { this.isRunning ? this.stop() : this.start(); },
            start() {
                this.isRunning = true; document.getElementById('focus-start-stop').textContent = 'Pauza';
                this.timerInterval = setInterval(() => {
                    this.timeLeft--; this.updateDisplay();
                    if (this.timeLeft <= 0) {
                        this.stop(); app.sendNotification('Koniec!', 'Czas na przerwę! Świetna robota!');
                        new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"+Array(300).join("12345678")).play();
                    }
                }, 1000);
            },
            stop() {
                this.isRunning = false; document.getElementById('focus-start-stop').textContent = 'Start';
                clearInterval(this.timerInterval);
            },
            reset() { this.stop(); this.timeLeft = 25 * 60; this.updateDisplay(); },
            updateDisplay() {
                const minutes = Math.floor(this.timeLeft / 60).toString().padStart(2, '0');
                const seconds = (this.timeLeft % 60).toString().padStart(2, '0');
                document.getElementById('focus-timer').textContent = `${minutes}:${seconds}`;
            }
        };
        const weeklyReview = {
            show() {
                const content = document.getElementById('weekly-review-content');
                const today = new Date(); const lastWeek = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 7);
                let winsCount = 0;
                for(const dateKey in app.state.wins) { const date = new Date(dateKey); if(date >= lastWeek && date <= today) winsCount += app.state.wins[dateKey].length; }
                const tasksCompleted = app.state.tasks.filter(t => t.completed && new Date(t.id.split('-')[1]) >= lastWeek).length;
                const tasksTotal = app.state.tasks.filter(t => new Date(t.id.split('-')[1]) >= lastWeek).length;
                content.innerHTML = `<h4>Twoje postępy w ostatnim tygodniu:</h4><p>🏆 Odnotowałaś <strong>${winsCount}</strong> zwycięstw. Brawo!</p><p>✅ Ukończyłaś <strong>${tasksCompleted}</strong> z ${tasksTotal > 0 ? tasksTotal : tasksCompleted} zadań.</p><hr><h4>Refleksja:</h4><p>Co poszło dobrze? Co można poprawić w nadchodzącym tygodniu?</p>`;
                app.showModal('weekly-review-modal');
            }
        };

        // Inicjalizacja Aplikacji
        app.init();
    });
    </script>
</body>
</html>